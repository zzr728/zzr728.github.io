

<!DOCTYPE html>
<html lang="en" color-mode=light>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>deepflux详解 - Rui&#39;s blog</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="google" content="notranslate" />
  <meta name="keywords" content="chaoo">
  <meta name="description" content="The first blog is the detai...">
  <meta name="author" content="Zhang Ze Rui">
  <link rel="icon" href="/images/icons/favicon-16x16.png" type="image/png" sizes="16x16">
  <link rel="icon" href="/images/icons/favicon-32x32.png" type="image/png" sizes="32x32">
  <link rel="apple-touch-icon" href="/images/icons/apple-touch-icon.png" sizes="180x180">
  <meta rel="mask-icon" href="/images/icons/stun-logo.svg" color="#333333">
  
    <meta rel="msapplication-TileImage" content="/images/icons/favicon-144x144.png">
    <meta rel="msapplication-TileColor" content="#000000">
  

  
<link rel="stylesheet" href="/css/style.css">


  
    
<link rel="stylesheet" href="//at.alicdn.com/t/font_1445822_p6ry5n7lrr.css">

  

  
    
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css">

  

  
    
      
        
        
<link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.18.1/styles/xcode.min.css" name="highlight-style" mode="light">

      
        
        
<link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.18.1/styles/solarized-dark.min.css" name="highlight-style" mode="dark">

      
  

  <script>
    var CONFIG = window.CONFIG || {};
    var ZHAOO = window.ZHAOO || {};
    CONFIG = {
      isHome: false,
      fancybox: true,
      pjax: false,
      loading: {
        gif: '/images/theme/loading.gif',
        lottie: ''
      },
      lazyload: {
        enable: true,
        only_post: 'false',
        loading: {
          gif: '/images/theme/loading.gif',
          lottie: ''
        }
      },
      donate: {
        enable: true,
        alipay: 'https://pic.izhaoo.com/alipay.jpg',
        wechat: 'https://pic.izhaoo.com/wechat.jpg'
      },
      galleries: {
        enable: true
      },
      fab: {
        enable: true,
        always_show: false
      },
      carrier: {
        enable: true
      },
      daovoice: {
        enable: false
      },
      preview: {
        background: {
          default: '',
          api: ''
        },
        motto: {
          default: '别怕，我们都将孤独地长大',
          typing: true,
          api: '',
          data_contents: '["data","content"]'
        },
      },
      qrcode: {
        enable: true,
        type: 'url',
        image: 'https://pic.izhaoo.com/weapp-code.jpg',
      },
      toc: {
        enable: true
      },
      scrollbar: {
        type: 'default'
      },
      notification: {
        enable: false,
        delay: 4500,
        list: '',
        page_white_list: '',
        page_black_list: ''
      },
      search: {
        enable: false,
        path: ''
      }
    }
  </script>

  

  

<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Rui's blog" type="application/atom+xml">
</head>

<body class="lock-screen">
  <div class="loading" id="loading"></div>
  
    


  <nav class="navbar">
    <div class="left">
      
        <i class="iconfont iconhome j-navbar-back-home"></i>
      
      
        <i class="iconfont iconqrcode j-navbar-qrcode"></i>
      
      
        <i class="iconfont iconmoono" id="color-toggle" color-toggle="light"></i>
      
      
    </div>
    <div class="center">deepflux详解</div>
    <div class="right">
      <i class="iconfont iconmenu j-navbar-menu"></i>
    </div>
    
      <div id="qrcode-navbar"></div>
    
  </nav>

  
  

<nav class="menu">
  <div class="menu-container">
    <div class="menu-close">
      <i class="iconfont iconbaseline-close-px"></i>
    </div>
    <ul class="menu-content"><li class="menu-item">
        <a href="/ " class="underline "> 首页</a>
      </li><li class="menu-item">
        <a href="/galleries/ " class="underline "> 摄影</a>
      </li><li class="menu-item">
        <a href="/archives/ " class="underline "> 归档</a>
      </li><li class="menu-item">
        <a href="/tags/ " class="underline "> 标签</a>
      </li><li class="menu-item">
        <a href="/categories/ " class="underline "> 分类</a>
      </li><li class="menu-item">
        <a href="/about/ " class="underline "> 关于</a>
      </li></ul>
    
      <div class="menu-copyright"><p>Powered by <a target="_blank" href="https://hexo.io">Hexo</a></p></div>
    
  </div>
</nav>
  <main id="main">
  <div class="article-wrap">
    <div class="row container">
      <div class="col-xl-3"></div>
      <div class="col-xl-6"><article class="article">
  <div class="wrap">
    <section class="head">
  <img   class="lazyload" data-original="/images/theme/blog1.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  draggable="false">
  <div class="head-mask">
    <h1 class="head-title">deepflux详解</h1>
    <div class="head-info">
      <span class="post-info-item"><i class="iconfont iconcalendar"></i>January 26, 2022</span>
      
      <span class="post-info-item"><i class="iconfont iconfont-size"></i>6323</span>
    </div>
  </div>
</section>
    <section class="main">
      <section class="content">
        
        <p>The first blog is the detailed annotation of deepflux，which appears in IJCV. And its link is <a target="_blank" rel="noopener" href="https://doi.org/10.1007/s11263-021-01430-6">here</a>.</p>
<p>The main reason I select this paper is the author is my mentor  and I have read it recently.</p>
<h2 id="Let’s-go"><a href="#Let’s-go" class="headerlink" title="Let’s go!"></a>Let’s go!</h2><h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction:"></a>Introduction:</h3><p>​        Skeletonization algorithms provide a concise and  effective representation of deformable objects, while supporting many applications, including object recognition and retrieval,pose estimation, balabala….（就是骨架检测能用到很多方面的运用，所以研究很重要）</p>
<p>所以这个时候就看下前人的related work，发现别人的work的效率不是很高。</p>
<p>for example：</p>
<ol>
<li>a gradient intensity map, driven by geometric constraints between skeletal pixels and edge fragments （根据骨架像素和边缘的几何约束的梯度来进行骨架的计算，但是就是在没有物体形状和位置信息的情况下是无法轻松的处理复杂数据的）</li>
<li>improved learning-based methods（虽然较上述的方法有了极大的提高——CNN给行业带来太大的巨变了，但是思想还是一个二分类像素的问题，但是在多个物体的场景，或者物体背景也有像素点时就会出现不太好的情况）</li>
</ol>
<p>于是在learning-based methods基础上提出了flux的想法：</p>
<p>​        training a convolutional neural network to predict a two-dimensional vector field encoding the flux representation.         Then recover the skeleton from the flux representation, which captures the position of skeletal pixels relative to         semantically meaningful entities, resulting in precise skeleton detection.（给每个像素点一个向量，也就是flux，然        后通过向量来计算骨架，相当于给分类增加了信息量。）</p>
<h3 id="Related-work"><a href="#Related-work" class="headerlink" title="Related work"></a>Related work</h3><p>As I mentioned in the above, the work is divide into two methods.</p>
<ul>
<li><p> The first method is a gradient intensity map, which includes a lot of different ways to achieve it , such as <a target="_blank" rel="noopener" href="https://arxiv.org/abs/1703.08628">AMAT</a>. However, they all haven’t very great performance.（因为没有太大参考价值，所以不做详细描述）</p>
</li>
<li><p>The second method is the learning-based method.</p>
</li>
</ul>
<h3 id="Methods"><a href="#Methods" class="headerlink" title="Methods"></a>Methods</h3><p><strong>The main idea :</strong></p>
<p>we define a two-dimensional unit flux vector pointing to the nearest skeleton pixel, generating a flux vector field. Within this representation, the object skeleton corresponds to pixels where the net inward flux is positive, following the motivation behind past flux-based methods for skeletonizing binary objects. We then use a CNN to learn the spatial context flux, via a pixel-wise regression task in place of binary classification（给上下文空间的像素点定义一个向量指向最近的骨架像素，这个向量就是通量，然后使用CNN来学习flux，通过每个像素的回归来代替二分类）</p>
<p>将像素点分为三类：</p>
<ul>
<li>Rs: skeleton pixels</li>
<li>Rb: background pixels</li>
<li>Rc: skeleton spatial context. they are obtained by dilating the binary skeleton map with a disk of radius r, and subtract skeleton pixels Rs </li>
</ul>
<p>Then define skeleton points as the local flux minima, or, alternatively, as sinks “absorbing” flux from nearby points，This approach leads to more robust localization and better connectivity between skeletal branches</p>
<p>于是通量F(p)为</p>
<p><img   class="lazyload" data-original="/2022/01/26/deepflux/1.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" ></p>
<p>Use the color wheel to show the correspondence between color and orientation:</p>
<p><img   class="lazyload" data-original="/2022/01/26/deepflux/flux2.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" ></p>
<p> <strong>Advantages:</strong></p>
<p>​        利用了每个候选像素周围的邻域内通量预测之间的一致性。如果骨架位置发生变化，其周围的通量场也会发生显著变化。一个有益的副作用是，该方法不直接依赖于更深层CNN层产生的粗反应来定位更大尺度的骨骼，这进一步减少了定位误差。这些特性使骨架点的定位更加稳健，特别是在结扎点周围，更不容易出现缺口、不连续和不规则性。</p>
<p>Then we can see the figure:<br><img   class="lazyload" data-original="/2022/01/26/deepflux/3.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" ></p>
<p>it can recover medial axes reflecting object part symmetries by localizing points with high inward flux (followed by a morphological closing), or by using additional convolution layers, which makes the entire pipeline end-to-end trainable（就是说通量这个信息量可以使用额外的卷积层来学习，或者使用通量大的信息进行定位）</p>
<p><strong>Network structure:</strong></p>
<p>The model is divided by 5 modules:</p>
<ol>
<li>a backbone network used to extract 3-dimension feature map</li>
<li>ASPP module</li>
<li>a multi-stage feature fusion module</li>
<li>a flux regression and skeleton classification by convolution and up-sampling module</li>
<li>an optional skeleton scale prediction branch</li>
</ol>
<p>The backbone network:VGG16,but discard the last pooling and the fully connected layers,and define it as DeepFlux-VGG16.(The first module)</p>
<p>The main reason of using ASPP module is that we need a wider receptive  field,we should guarantee the receptive field is wider than the biggest radius in the entity of input image,but the receptive field of VGG is 196, it’s not enough.</p>
<p>The main way to achieve the ASPP module  is adding four parallel atrous convolutional layers with 3 × 3 kernels but different atrous rates (2, 4, 8, 16) to the last layer of the backbone, followed by a concatenation along the channel dimension. Then we obtain  a feature map with a theoretical receptive field of 708 and it’s enough for the task.(The second module)</p>
<p>ASPP解释：</p>
<p><img   class="lazyload" data-original="/2022/01/26/deepflux/ASPP2.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" ></p>
<p>就是说保持了输出的尺寸，让出来的特征变大也就是感受野变大。</p>
<p>In the following I show the way to calculate the receptive field:</p>
<p><img   class="lazyload" data-original="/2022/01/26/deepflux/receptive_field.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" ></p>
<p>we fuse the feature maps from side outputs at conv3, conv4, conv5, and ASPP layers, after convolving them with  1 × 1 kernel, we adjust them to the dimension of conv3(feature maps at different levels have different spatial resolutions), then predict the learnt flux field and use the  bilinear interpolation to  up-sample it to the  dimension of input image ,which is  a 2-channel response map, corresponding to flux predictions Fˆ(p) for every pixel p in the image.(The third module and the fourth module,用双线性插值进行上采样来resize确定像素点的F(p)值)</p>
<p>上采样方法(up-sample)：<br><img   class="lazyload" data-original="/2022/01/26/deepflux/up-sample.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" ></p>
<p>Then we should extract the skeleton from the 2-channel response map, and we have two approaches to make it.</p>
<ol>
<li>for a given pixel,the direction of it  is binned into one of 8 directions, pointing to one of the 8 neighbors. Pixels close to the real object skeleton should have a high inward flux,because the skeleton is  the local flux minima. Finally, we apply a morphological dilation with a disk structuring element of radius k1, followed by a morphological erosion with a disk of radius k2, to group quench points together and produce the object skeleton.(DeepFlux-P，因为骨架点是局部最小值，所以利用flux值有较大向内通量的特性找到骨架)</li>
<li>extend our network by plugging in three 3 × 3 convolutional layers (with 64-channel output for the first two layers), following the (up-sampled) flux field prediction layers, which output a pixel-wise skeleton confidence score to produce a binary skeleton(DeepFlux-E,也是默认值，使用3*3的卷积层然后预测flux得到一个score，通过score来找到骨架)</li>
</ol>
<p>具体过程如下：</p>
<p><img   class="lazyload" data-original="/2022/01/26/deepflux/ASPP.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" ></p>
<p><strong>Loss:</strong></p>
<p>For the flux  field branch, due to a severe imbalance in the number of context and background pixels, we adopt a class-balancing strategy similar to <a target="_blank" rel="noopener" href="https://openaccess.thecvf.com/content_iccv_2015/papers/Xie_Holistically-Nested_Edge_Detection_ICCV_2015_paper.pdf">the one</a> </p>
<p>and the loss is:</p>
<p><img   class="lazyload" data-original="/2022/01/26/deepflux/loss2.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" ></p>
<p>The second branch uses a class-balanced cross-entropy loss function, which predicts skeleton probability scores from the predicted flux.</p>
<p>the loss is:</p>
<p><img   class="lazyload" data-original="/2022/01/26/deepflux/loss_cross.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" ></p>
<p><img   class="lazyload" data-original="/2022/01/26/deepflux/explain.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" ></p>
<p>The final training objective is given by summing the two loss terms.</p>
<p><img   class="lazyload" data-original="/2022/01/26/deepflux/final_los.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" ></p>
<p>For the optional extra scale prediction branch, we use a smoothed-L1 loss for scale regression:</p>
<p><img   class="lazyload" data-original="/2022/01/26/deepflux/smooth_loss.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" ></p>
<p>Then, the final loss is:                                              <img   class="lazyload" data-original="/2022/01/26/deepflux/final_loss.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" ></p>
<p>Loss计算方法：<br><img   class="lazyload" data-original="/2022/01/26/deepflux/loss_cal.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" ></p>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>这篇提出的方法缓解了以前方法的许多局限性(例如：定位不良)，在处理大空间尺度上的结扎点和物体骨架方面表现得非常好，同时速度也非常快。</p>

      </section>
      <section class="extra">
        
          <ul class="copyright">
  
    <li><strong>本文作者：</strong>Zhang Ze Rui</li>
    <li><strong>本文链接：</strong><a href="https://rui728.com/2022/01/26/deepflux/index.html" title="https:&#x2F;&#x2F;rui728.com&#x2F;2022&#x2F;01&#x2F;26&#x2F;deepflux&#x2F;index.html">https:&#x2F;&#x2F;rui728.com&#x2F;2022&#x2F;01&#x2F;26&#x2F;deepflux&#x2F;index.html</a></li>
    <li><strong>版权声明：</strong>本博客所有文章均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" title="BY-NC-SA" target="_blank" rel="noopener">BY-NC-SA</a> 许可协议，转载请注明出处！</li>
  
</ul>
        
        
          <section class="donate">
  <div id="qrcode-donate">
    <img   class="lazyload" data-original="https://pic.izhaoo.com/alipay.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" >
  </div>
  <div class="icon">
    <a href="javascript:;" id="alipay"><i class="iconfont iconalipay"></i></a>
    <a href="javascript:;" id="wechat"><i class="iconfont iconwechat-fill"></i></a>
  </div>
</section>
        
        
        
      </section>
      
        <section class="comments">
  
    <div class="btn" id="comments-btn">查看评论</div>
  
  
<div id="valine"></div>
<script defer src="//unpkg.com/valine/dist/Valine.min.js"></script>
<script>
  window.onload = function () {
    var loadValine = function () {
      new Valine({
        el: '#valine',
        app_id: "KTTvK89Ym9sJUzw7AEnVLQCG-gzGzoHsz",
        app_key: "OUIqcMpQxPPrIJLwCMwCl9RB",
        placeholder: "Just go go",
        avatar: "mm",
        pageSize: "10",
        lang: "",
      });
    }
    if ( true ) {
      $("#comments-btn").on("click", function () {
        $(this).hide();
        loadValine();
      });
    } else {
      loadValine();
    }
  };
</script>

</section>
      
    </section>
  </div>
</article></div>
      <div class="col-xl-3">
        
          
  <aside class="toc-wrap">
    <h3 class="toc-title">文章目录：</h3>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Let%E2%80%99s-go"><span class="toc-text">Let’s go!</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Introduction"><span class="toc-text">Introduction:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Related-work"><span class="toc-text">Related work</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Methods"><span class="toc-text">Methods</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Conclusion"><span class="toc-text">Conclusion</span></a></li></ol></li></ol>
  </aside>

        
      </div>
    </div>
  </div>
</main>
  

<footer class="footer">
  <div class="footer-social"><a 
        href="tencent://message/?Menu=yes&uin=1030757195 "
        target="_blank"
        class="footer-social-item"
        onMouseOver="this.style.color= '#12B7F5'" 
        onMouseOut="this.style.color='#33333D'">
          <i class="iconfont  iconQQ "></i>
      </a><a 
        href="1030757195@qq.com "
        target="_blank"
        class="footer-social-item"
        onMouseOver="this.style.color=#FF3B00" 
        onMouseOut="this.style.color='#33333D'">
          <i class="iconfont  iconmail"></i>
      </a></div>
  
    <div class="footer-copyright"><p>Powered by <a target="_blank" href="https://hexo.io">Hexo</a></p></div>
  
</footer>
  
      <div class="fab fab-plus">
    <i class="iconfont iconplus"></i>
  </div>
  
  
  
  <div class="fab fab-up">
    <i class="iconfont iconcaret-up"></i>
  </div>
  
  
  
    
<script src="/js/color-mode.js"></script>

  
  
</body>

<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>





  
<script src="https://cdn.bootcdn.net/ajax/libs/jquery.lazyload/1.9.1/jquery.lazyload.min.js"></script>




  
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>






  
<script src="https://cdn.bootcdn.net/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>




<script src="/js/utils.js"></script>
<script src="/js/script.js"></script>







  <script>
    (function () {
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
      } else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>













</html>